<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tree & Fungi Trainer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: #f1f5f9;
  padding: 20px;
  min-height: 100vh;
}
.container { max-width: 1000px; margin: 0 auto; }
h1 { 
  text-align: center; 
  color: #22c55e; 
  font-size: 2rem; 
  margin-bottom: 30px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.level-selector {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.level-card {
  background: linear-gradient(135deg, #1e293b, #334155);
  padding: 20px;
  border-radius: 12px;
  border: 2px solid rgba(34,197,94,0.2);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}
.level-card:hover:not(.locked) {
  transform: translateY(-4px);
  border-color: #22c55e;
  box-shadow: 0 8px 16px rgba(34,197,94,0.3);
}
.level-card.active {
  border-color: #22c55e;
  background: linear-gradient(135deg, #16a34a, #22c55e);
}
.level-card.locked {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: rgba(100,116,139,0.3);
}
.level-card.locked::after {
  content: 'üîí';
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 24px;
}
.level-card.dev-unlocked::after {
  content: 'üîì';
  color: #a855f7;
}
.level-title {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 8px;
  color: #fff;
}
.level-card.locked .level-title { color: #94a3b8; }
.level-subtitle {
  font-size: 0.9rem;
  color: rgba(255,255,255,0.8);
  margin-bottom: 12px;
}
.level-card.locked .level-subtitle { color: #64748b; }
.level-stats {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.2);
}
.level-card.locked .level-stats { border-color: rgba(100,116,139,0.2); }
.unlock-requirement {
  background: rgba(15,23,42,0.8);
  padding: 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  color: #fbbf24;
  text-align: center;
  margin-top: 8px;
}
.difficulty-toggle {
  background: rgba(30,41,59,0.8);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: none;
}
.difficulty-toggle.show { display: block; }
.difficulty-toggle label {
  color: #cbd5e1;
  font-weight: 600;
  margin-right: 15px;
}
.difficulty-buttons {
  display: inline-flex;
  gap: 10px;
}
.diff-btn {
  padding: 8px 16px;
  border: 2px solid rgba(100,116,139,0.3);
  background: rgba(15,23,42,0.6);
  color: #f1f5f9;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}
.diff-btn:hover {
  border-color: #22c55e;
  background: rgba(34,197,94,0.2);
}
.diff-btn.active {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  border-color: #22c55e;
  color: #fff;
}
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.stat-card {
  background: rgba(30,41,59,0.8);
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  border: 1px solid rgba(34,197,94,0.2);
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: #22c55e;
}
.stat-label {
  font-size: 12px;
  color: #94a3b8;
  text-transform: uppercase;
  margin-top: 5px;
}
.filter-bar {
  background: rgba(30,41,59,0.8);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
.filter-bar label { color: #cbd5e1; font-weight: 600; }
.filter-bar select {
  padding: 8px 12px;
  border-radius: 6px;
  background: rgba(15,23,42,0.8);
  color: #f1f5f9;
  border: 2px solid rgba(100,116,139,0.3);
  font-size: 14px;
}
.card {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  border: 1px solid rgba(34,197,94,0.2);
  margin-bottom: 20px;
}
.image-container {
  width: 100%;
  max-height: 300px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
  background: rgba(15,23,42,0.6);
  border-radius: 8px;
  padding: 10px;
}
.image-container img {
  max-width: 100%;
  max-height: 280px;
  object-fit: contain;
  border-radius: 8px;
}
.question-text {
  font-size: 1.2rem;
  color: #cbd5e1;
  text-align: center;
  margin-bottom: 20px;
  line-height: 1.6;
}
.meta-info {
  text-align: center;
  color: #94a3b8;
  font-size: 13px;
  margin-bottom: 15px;
}
.options {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
@media (min-width: 640px) {
  .options { grid-template-columns: 1fr 1fr; }
}
.option {
  background: rgba(30,41,59,0.8);
  padding: 15px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid rgba(100,116,139,0.3);
  transition: all 0.2s;
  font-size: 15px;
}
.option:hover {
  background: rgba(51,65,85,0.9);
  border-color: rgba(34,197,94,0.5);
  transform: translateY(-2px);
}
.option.correct {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  border-color: #22c55e;
  font-weight: 600;
}
.option.wrong {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: #fff;
  border-color: #f87171;
  font-weight: 600;
}
.option.disabled {
  pointer-events: none;
  opacity: 0.6;
}
.explanation {
  background: rgba(15,23,42,0.9);
  padding: 20px;
  border-radius: 8px;
  border-left: 4px solid #22c55e;
  display: none;
  margin-bottom: 20px;
}
.explanation.show { display: block; }
.explanation h4 {
  color: #22c55e;
  margin-bottom: 10px;
}
.explanation p {
  margin: 10px 0;
  line-height: 1.6;
}
.explanation strong { color: #cbd5e1; }
.explanation details {
  margin-top: 15px;
}
.explanation summary {
  color: #60a5fa;
  font-weight: 600;
  cursor: pointer;
  padding: 8px;
  background: rgba(30,41,59,0.5);
  border-radius: 4px;
}
.explanation summary:hover {
  background: rgba(51,65,85,0.7);
}
.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
}
.btn-primary {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(34,197,94,0.4);
}
.btn-secondary {
  background: transparent;
  border: 2px solid rgba(34,197,94,0.4);
  color: #22c55e;
}
.btn-secondary:hover {
  background: rgba(34,197,94,0.1);
  border-color: #22c55e;
}
.loading {
  text-align: center;
  color: #60a5fa;
  padding: 40px;
}
.error {
  background: rgba(239,68,68,0.2);
  border: 2px solid #ef4444;
  color: #fca5a5;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}
.hidden { display: none; }
.unlock-toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  padding: 30px 40px;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  font-size: 1.5rem;
  font-weight: 700;
  z-index: 1000;
  animation: unlockPulse 0.6s ease-out;
}
@keyframes unlockPulse {
  0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
  50% { transform: translate(-50%, -50%) scale(1.1); }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}
</style>
</head>
<body>

<div class="container">
  <h1>üå≤ Tree & Fungi Trainer</h1>

  <div class="level-selector">
    <div class="level-card active" id="level1Card" onclick="selectLevel('level1')">
      <div class="level-title">Level 1</div>
      <div class="level-subtitle">Foundation Knowledge</div>
      <div class="level-stats">
        <span id="level1Questions">0 questions</span>
        <span id="level1Accuracy">-</span>
      </div>
    </div>

    <div class="level-card locked" id="level2Card" onclick="selectLevel('level2')">
      <div class="level-title">Level 2</div>
      <div class="level-subtitle">Advanced Practice</div>
      <div class="level-stats">
        <span id="level2Questions">0 questions</span>
        <span id="level2Accuracy">-</span>
      </div>
      <div class="unlock-requirement">üîí Score 70%+ on 100+ Level 1 questions to unlock</div>
    </div>

    <div class="level-card locked" id="level3Card" onclick="selectLevel('level3')">
      <div class="level-title">Level 3</div>
      <div class="level-subtitle">Professional Assessment</div>
      <div class="level-stats">
        <span id="level3Questions">0 questions</span>
        <span id="level3Accuracy">-</span>
      </div>
      <div class="unlock-requirement">üîí Score 75%+ on 100+ Level 2 questions to unlock</div>
    </div>
  </div>

  <div id="difficultyToggle" class="difficulty-toggle show">
    <label>Difficulty:</label>
    <div class="difficulty-buttons">
      <button class="diff-btn active" onclick="setDifficulty('standard')">Standard</button>
      <button class="diff-btn" onclick="setDifficulty('hard')">Hard</button>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalQuestions">-</div>
      <div class="stat-label">Questions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="attempted">0</div>
      <div class="stat-label">Attempted</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="weakCount">0</div>
      <div class="stat-label">Weak Areas</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="accuracy">-</div>
      <div class="stat-label">Accuracy</div>
    </div>
  </div>

  <div class="filter-bar">
    <label>Category:</label>
    <select id="categoryFilter">
      <option value="">All Categories</option>
    </select>
    <button class="btn btn-secondary" onclick="resetStats()">üîÑ Reset Level Stats</button>
  </div>

  <div id="errorDisplay" class="error hidden"></div>

  <div class="card">
    <div id="loadingIndicator" class="loading">
      <p>Loading questions...</p>
    </div>

    <div id="questionDisplay" class="hidden">
      <div id="imageContainer" class="image-container hidden"></div>
      
      <div class="question-text" id="questionText">Press Practice to start</div>
      
      <div class="meta-info" id="metaInfo"></div>
      
      <div class="options" id="optionsContainer"></div>
      
      <div class="explanation" id="explanation"></div>
      
      <div class="controls">
        <button class="btn btn-primary" onclick="practiceQuestion()">üéØ Practice</button>
        <button class="btn btn-secondary" onclick="nextQuestion()">Next ‚ûî</button>
        <button class="btn btn-secondary" onclick="practiceWeak()">üí™ Weak Areas (<span id="weakCountBtn">0</span>)</button>
      </div>
    </div>
  </div>

</div>

<script>
// ============================================
// TSV FILE URLS - GITHUB RAW LINKS
// ============================================
const TSV_URLS = {
  level1: 'https://raw.githubusercontent.com/Joeycost27/pti-trainer/main/tsv/Level1.tsv',
  level1_hard: 'https://raw.githubusercontent.com/Joeycost27/pti-trainer/main/tsv/Level1_Hard.tsv',
  level2: 'https://raw.githubusercontent.com/Joeycost27/pti-trainer/main/tsv/Level2.tsv',
  level3: 'pending'
};

// ============================================
// STATE MANAGEMENT
// ============================================
let allQuestions = {
  level1: [],
  level1_hard: [],
  level2: [],
  level3: []
};

let currentLevel = 'level1';
let currentDifficulty = 'standard';
let currentQuestion = null;
let filteredQuestions = [];
let devModeActive = false;

let stats = {
  level1: { attempted: 0, correct: 0, weak: new Set() },
  level1_hard: { attempted: 0, correct: 0, weak: new Set() },
  level2: { attempted: 0, correct: 0, weak: new Set() },
  level3: { attempted: 0, correct: 0, weak: new Set() }
};

const STATS_KEY = 'treeTrainerStatsV2';
const DEV_KEY = 'treeTrainerDevMode';

const UNLOCK_REQUIREMENTS = {
  level2: { level: 'level1', threshold: 70, minAttempts: 100 },
  level3: { level: 'level2', threshold: 75, minAttempts: 100 }
};

// ============================================
// INITIALIZATION
// ============================================
function loadDevMode() {
  const saved = localStorage.getItem(DEV_KEY);
  if (saved === 'true') {
    devModeActive = true;
    console.log('üîì Developer mode active');
    console.log('To disable: localStorage.removeItem("treeTrainerDevMode"); location.reload();');
  } else {
    console.log('üîë To enable dev mode (unlock all levels):');
    console.log('localStorage.setItem("treeTrainerDevMode", "true"); location.reload();');
  }
}

function init() {
  loadStats();
  loadDevMode();
  loadQuestions();
  checkUnlocks();
  updateLevelCards();
  selectLevel('level1');
}

async function loadQuestions() {
  document.getElementById('loadingIndicator').classList.remove('hidden');
  document.getElementById('questionDisplay').classList.add('hidden');
  
  console.log('üì• Loading TSV files from GitHub...');
  
  try {
    const promises = [];
    
    for (const [level, url] of Object.entries(TSV_URLS)) {
      if (url && url !== 'pending') {
        promises.push(
          fetch(url)
            .then(r => {
              console.log(`Fetching ${level}: ${r.status} ${r.statusText}`);
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              return r.text();
            })
            .then(text => {
              allQuestions[level] = parseCSV(text);
              console.log(`‚úÖ ${level}: ${allQuestions[level].length} questions loaded`);
            })
            .catch(err => {
              console.error(`‚ùå Failed to load ${level}:`, err);
              showError(`Failed to load ${level}: ${err.message}`);
            })
        );
      }
    }
    
    await Promise.all(promises);
    
    document.getElementById('loadingIndicator').classList.add('hidden');
    document.getElementById('questionDisplay').classList.remove('hidden');
    
    console.log('‚úÖ All loading complete');
    updateLevelCards();
    selectLevel(currentLevel);
    
  } catch (error) {
    console.error('‚ùå Loading error:', error);
    showError('Failed to load questions: ' + error.message);
    document.getElementById('loadingIndicator').classList.add('hidden');
  }
}

function loadStats() {
  const saved = localStorage.getItem(STATS_KEY);
  if (saved) {
    const parsed = JSON.parse(saved);
    Object.keys(stats).forEach(level => {
      if (parsed[level]) {
        stats[level].attempted = parsed[level].attempted || 0;
        stats[level].correct = parsed[level].correct || 0;
        stats[level].weak = new Set(parsed[level].weak || []);
      }
    });
  }
}

function saveStats() {
  const toSave = {};
  Object.keys(stats).forEach(level => {
    toSave[level] = {
      attempted: stats[level].attempted,
      correct: stats[level].correct,
      weak: Array.from(stats[level].weak)
    };
  });
  localStorage.setItem(STATS_KEY, JSON.stringify(toSave));
  updateStatsDisplay();
  checkUnlocks();
}

function loadUnlocks() {
  const unlocks = { level1: true, level1_hard: true, level2: false, level3: false };
  
  if (devModeActive) {
    return { level1: true, level1_hard: true, level2: true, level3: true };
  }
  
  const shownToasts = JSON.parse(localStorage.getItem('treeTrainerToastsShown') || '{}');
  
  const level1Accuracy = getAccuracy('level1');
  const level1HardAccuracy = getAccuracy('level1_hard');
  const bestLevel1Accuracy = Math.max(level1Accuracy, level1HardAccuracy);
  const level1Attempts = stats.level1.attempted + stats.level1_hard.attempted;
  
  if (bestLevel1Accuracy >= UNLOCK_REQUIREMENTS.level2.threshold && 
      level1Attempts >= UNLOCK_REQUIREMENTS.level2.minAttempts) {
    unlocks.level2 = true;
    
    if (!shownToasts.level2) {
      showUnlockToast('üéâ Level 2 Unlocked!');
      shownToasts.level2 = true;
      localStorage.setItem('treeTrainerToastsShown', JSON.stringify(shownToasts));
    }
  }
  
  const level2Accuracy = getAccuracy('level2');
  const level2Attempts = stats.level2.attempted;
  
  if (level2Accuracy >= UNLOCK_REQUIREMENTS.level3.threshold && 
      level2Attempts >= UNLOCK_REQUIREMENTS.level3.minAttempts) {
    unlocks.level3 = true;
    
    if (!shownToasts.level3) {
      showUnlockToast('üéâ Level 3 Unlocked!');
      shownToasts.level3 = true;
      localStorage.setItem('treeTrainerToastsShown', JSON.stringify(shownToasts));
    }
  }
  
  return unlocks;
}

function checkUnlocks() {
  updateLevelCards();
}

function showUnlockToast(message) {
  const toast = document.createElement('div');
  toast.className = 'unlock-toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

function getAccuracy(level) {
  if (stats[level].attempted === 0) return 0;
  return Math.round((stats[level].correct / stats[level].attempted) * 100);
}

function updateStatsDisplay() {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const currentStats = stats[levelKey];
  
  document.getElementById('totalQuestions').textContent = filteredQuestions.length;
  document.getElementById('attempted').textContent = currentStats.attempted;
  document.getElementById('weakCount').textContent = currentStats.weak.size;
  document.getElementById('weakCountBtn').textContent = currentStats.weak.size;
  
  const accuracy = getAccuracy(levelKey);
  document.getElementById('accuracy').textContent = currentStats.attempted > 0 ? accuracy + '%' : '-';
}

function updateLevelCards() {
  const unlocks = loadUnlocks();
  
  const level1Total = allQuestions.level1.length + allQuestions.level1_hard.length;
  document.getElementById('level1Questions').textContent = `${level1Total} questions`;
  const level1Acc = Math.max(getAccuracy('level1'), getAccuracy('level1_hard'));
  document.getElementById('level1Accuracy').textContent = level1Acc > 0 ? level1Acc + '%' : '-';
  
  document.getElementById('level2Questions').textContent = `${allQuestions.level2.length} questions`;
  const level2Acc = getAccuracy('level2');
  document.getElementById('level2Accuracy').textContent = level2Acc > 0 ? level2Acc + '%' : '-';
  
  const level2Card = document.getElementById('level2Card');
  if (unlocks.level2) {
    level2Card.classList.remove('locked');
    if (devModeActive) level2Card.classList.add('dev-unlocked');
  } else {
    level2Card.classList.add('locked');
    level2Card.classList.remove('dev-unlocked');
  }
  
  document.getElementById('level3Questions').textContent = `${allQuestions.level3.length} questions`;
  const level3Acc = getAccuracy('level3');
  document.getElementById('level3Accuracy').textContent = level3Acc > 0 ? level3Acc + '%' : '-';
  
  const level3Card = document.getElementById('level3Card');
  if (unlocks.level3) {
    level3Card.classList.remove('locked');
    if (devModeActive) level3Card.classList.add('dev-unlocked');
  } else {
    level3Card.classList.add('locked');
    level3Card.classList.remove('dev-unlocked');
  }
}

function selectLevel(level) {
  const unlocks = loadUnlocks();
  
  if (!unlocks[level]) {
    return;
  }
  
  currentLevel = level;
  
  document.querySelectorAll('.level-card').forEach(card => {
    card.classList.remove('active');
  });
  document.getElementById(level + 'Card').classList.add('active');
  
  if (level === 'level1') {
    document.getElementById('difficultyToggle').classList.add('show');
  } else {
    document.getElementById('difficultyToggle').classList.remove('show');
    currentDifficulty = 'standard';
  }
  
  loadCurrentLevel();
}

function setDifficulty(difficulty) {
  currentDifficulty = difficulty;
  
  document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  loadCurrentLevel();
}

function loadCurrentLevel() {
  let questions = [];
  
  if (currentLevel === 'level1') {
    questions = currentDifficulty === 'standard' ? allQuestions.level1 : allQuestions.level1_hard;
  } else {
    questions = allQuestions[currentLevel];
  }
  
  questions = questions.filter(q => q.active === 'YES');
  
  buildCategoryFilter(questions);
  filterQuestions(questions);
  
  updateStatsDisplay();
}

function buildCategoryFilter(questions) {
  const categories = [...new Set(questions.map(q => q.category))].sort();
  const select = document.getElementById('categoryFilter');
  
  select.innerHTML = '<option value="">All Categories</option>';
  categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
  
  select.onchange = () => {
    const allLevelQuestions = currentLevel === 'level1' 
      ? (currentDifficulty === 'standard' ? allQuestions.level1 : allQuestions.level1_hard)
      : allQuestions[currentLevel];
    filterQuestions(allLevelQuestions.filter(q => q.active === 'YES'));
  };
}

function filterQuestions(questions) {
  const category = document.getElementById('categoryFilter').value;
  filteredQuestions = category 
    ? questions.filter(q => q.category === category)
    : [...questions];
  updateStatsDisplay();
}

function parseCSV(csv) {
  const lines = csv.split('\n');
  const result = [];
  
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    
    const parts = lines[i].split('\t');
    if (parts.length < 14) continue;
    
    const question = {
      id: parseInt(parts[0]),
      active: parts[1],
      category: parts[2],
      question: parts[3],
      optionA: parts[4],
      optionB: parts[5],
      optionC: parts[6],
      optionD: parts[7],
      correctAnswer: parseInt(parts[8]),
      learn: parts[9],
      whyMatters: parts[10],
      deepDive: parts[11] || '',
      imageRef: parts[12] || '',
      notes: parts[13] || ''
    };
    
    result.push(question);
  }
  
  return result;
}

function practiceQuestion() {
  const pool = filteredQuestions.length > 0 ? filteredQuestions : getCurrentQuestions();
  if (pool.length === 0) {
    alert('No questions available');
    return;
  }
  
  currentQuestion = pool[Math.floor(Math.random() * pool.length)];
  displayQuestion(currentQuestion);
}

function nextQuestion() {
  practiceQuestion();
}

function practiceWeak() {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const allLevelQuestions = getCurrentQuestions();
  const weakQuestions = allLevelQuestions.filter(q => stats[levelKey].weak.has(q.id));
  
  if (weakQuestions.length === 0) {
    alert('No weak areas yet. Answer questions incorrectly to add them here for review.');
    return;
  }
  
  currentQuestion = weakQuestions[Math.floor(Math.random() * weakQuestions.length)];
  displayQuestion(currentQuestion);
}

function getCurrentQuestions() {
  if (currentLevel === 'level1') {
    return currentDifficulty === 'standard' ? allQuestions.level1 : allQuestions.level1_hard;
  }
  return allQuestions[currentLevel];
}

function displayQuestion(q) {
  document.getElementById('explanation').classList.remove('show');
  
  const imageContainer = document.getElementById('imageContainer');
  if (q.imageRef) {
    imageContainer.innerHTML = `<img src="images/${q.imageRef}.jpg" alt="Question ${q.id}" onerror="this.parentElement.classList.add('hidden')">`;
    imageContainer.classList.remove('hidden');
  } else {
    imageContainer.classList.add('hidden');
  }
  
  document.getElementById('questionText').textContent = q.question;
  
  const levelDisplay = currentLevel === 'level1' 
    ? `Level 1 (${currentDifficulty === 'standard' ? 'Standard' : 'Hard'})` 
    : `Level ${currentLevel.replace('level', '')}`;
  document.getElementById('metaInfo').textContent = `${levelDisplay} | ${q.category} | Question ${q.id}`;
  
  const options = [
    { text: q.optionA, index: 0 },
    { text: q.optionB, index: 1 },
    { text: q.optionC, index: 2 },
    { text: q.optionD, index: 3 }
  ];
  
  for (let i = options.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [options[i], options[j]] = [options[j], options[i]];
  }
  
  q._shuffledOptions = options;
  
  const container = document.getElementById('optionsContainer');
  container.innerHTML = '';
  
  options.forEach((opt, displayIndex) => {
    const div = document.createElement('div');
    div.className = 'option';
    div.textContent = opt.text;
    div.onclick = () => handleAnswer(q, displayIndex);
    container.appendChild(div);
  });
}

function handleAnswer(q, displayIndex) {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const options = document.querySelectorAll('.option');
  const selectedOption = q._shuffledOptions[displayIndex];
  const correctOption = q._shuffledOptions.find(opt => opt.index === q.correctAnswer);
  const correctDisplayIndex = q._shuffledOptions.indexOf(correctOption);
  
  options.forEach(opt => {
    opt.onclick = null;
    opt.classList.add('disabled');
  });
  
  stats[levelKey].attempted++;
  
  if (selectedOption.index === q.correctAnswer) {
    options[displayIndex].classList.add('correct');
    stats[levelKey].correct++;
    showExplanation(q, true);
  } else {
    options[displayIndex].classList.add('wrong');
    options[correctDisplayIndex].classList.add('correct');
    stats[levelKey].weak.add(q.id);
    showExplanation(q, false);
  }
  
  saveStats();
}

function showExplanation(q, isCorrect) {
  const explanation = document.getElementById('explanation');
  
  let html = isCorrect
    ? '<p style="color: #22c55e; font-weight: bold; font-size: 1.1rem;">‚úî Correct!</p>'
    : '<p style="color: #ef4444; font-weight: bold; font-size: 1.1rem;">‚úó Incorrect</p>';
  
  html += `<p><strong>Key Learning:</strong> ${q.learn}</p>`;
  html += `<p><strong>Why It Matters:</strong> ${q.whyMatters}</p>`;
  
  if (q.deepDive) {
    const formattedDeepDive = q.deepDive.replace(/<br>/g, '<br>');
    html += `<details><summary>üìñ Deep Dive</summary><div style="margin-top: 12px;">${formattedDeepDive}</div></details>`;
  }
  
  if (q.notes) {
    html += `<details><summary>üìù Notes</summary><div style="margin-top: 12px;">${q.notes}</div></details>`;
  }
  
  explanation.innerHTML = html;
  explanation.classList.add('show');
}

function resetStats() {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const levelName = currentLevel === 'level1' 
    ? `Level 1 (${currentDifficulty === 'standard' ? 'Standard' : 'Hard'})` 
    : `Level ${currentLevel.replace('level', '')}`;
  
  if (confirm(`Reset all progress for ${levelName}? This will clear stats and weak areas for this level only.`)) {
    stats[levelKey] = { attempted: 0, correct: 0, weak: new Set() };
    saveStats();
    alert('‚úÖ Level stats reset');
  }
}

function showError(message) {
  const errorDiv = document.getElementById('errorDisplay');
  errorDiv.textContent = '‚ö† Error: ' + message;
  errorDiv.classList.remove('hidden');
}

init();
</script>

</body>
</html>
