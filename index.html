<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tree & Fungi Trainer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: #f1f5f9;
  padding: 20px;
  min-height: 100vh;
}
.container { max-width: 1000px; margin: 0 auto; }
h1 { 
  text-align: center; 
  color: #22c55e; 
  font-size: 2rem; 
  margin-bottom: 30px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* Level Selection */
.level-selector {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.level-card {
  background: linear-gradient(135deg, #1e293b, #334155);
  padding: 20px;
  border-radius: 12px;
  border: 2px solid rgba(34,197,94,0.2);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}
.level-card:hover:not(.locked) {
  transform: translateY(-4px);
  border-color: #22c55e;
  box-shadow: 0 8px 16px rgba(34,197,94,0.3);
}
.level-card.active {
  border-color: #22c55e;
  background: linear-gradient(135deg, #16a34a, #22c55e);
}
.level-card.locked {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: rgba(100,116,139,0.3);
}
.level-card.locked::after {
  content: 'üîí';
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 24px;
}
.level-title {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 8px;
  color: #fff;
}
.level-card.locked .level-title { color: #94a3b8; }
.level-subtitle {
  font-size: 0.9rem;
  color: rgba(255,255,255,0.8);
  margin-bottom: 12px;
}
.level-card.locked .level-subtitle { color: #64748b; }
.level-stats {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.2);
}
.level-card.locked .level-stats { border-color: rgba(100,116,139,0.2); }
.unlock-requirement {
  background: rgba(15,23,42,0.8);
  padding: 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  color: #fbbf24;
  text-align: center;
  margin-top: 8px;
}

/* Difficulty Toggle for Level 1 */
.difficulty-toggle {
  background: rgba(30,41,59,0.8);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: none;
}
.difficulty-toggle.show { display: block; }
.difficulty-toggle label {
  color: #cbd5e1;
  font-weight: 600;
  margin-right: 15px;
}
.difficulty-buttons {
  display: inline-flex;
  gap: 10px;
}
.diff-btn {
  padding: 8px 16px;
  border: 2px solid rgba(100,116,139,0.3);
  background: rgba(15,23,42,0.6);
  color: #f1f5f9;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}
.diff-btn:hover {
  border-color: #22c55e;
  background: rgba(34,197,94,0.2);
}
.diff-btn.active {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  border-color: #22c55e;
  color: #fff;
}

/* Developer Controls */
.dev-controls {
  background: rgba(59,130,246,0.1);
  border: 2px dashed #3b82f6;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: none;
}
.dev-controls.show { display: block; }
.dev-toggle {
  text-align: right;
  margin-bottom: 10px;
}
.dev-toggle button {
  background: rgba(59,130,246,0.2);
  border: 1px solid #3b82f6;
  color: #60a5fa;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}
.dev-toggle button:hover {
  background: rgba(59,130,246,0.3);
}
.dev-controls h4 {
  color: #60a5fa;
  margin-bottom: 10px;
  font-size: 14px;
}
.dev-controls input {
  width: 100%;
  padding: 8px;
  border-radius: 4px;
  border: 1px solid #3b82f6;
  background: rgba(15,23,42,0.8);
  color: #f1f5f9;
  font-size: 13px;
  margin: 5px 0;
}
.dev-controls button.apply-btn {
  background: #3b82f6;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  margin-top: 10px;
}
.mode-indicator {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 10px;
}
.mode-embedded {
  background: rgba(34,197,94,0.2);
  color: #22c55e;
  border: 1px solid #22c55e;
}
.mode-url {
  background: rgba(59,130,246,0.2);
  color: #60a5fa;
  border: 1px solid #3b82f6;
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.stat-card {
  background: rgba(30,41,59,0.8);
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  border: 1px solid rgba(34,197,94,0.2);
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: #22c55e;
}
.stat-label {
  font-size: 12px;
  color: #94a3b8;
  text-transform: uppercase;
  margin-top: 5px;
}
.filter-bar {
  background: rgba(30,41,59,0.8);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
.filter-bar label { color: #cbd5e1; font-weight: 600; }
.filter-bar select {
  padding: 8px 12px;
  border-radius: 6px;
  background: rgba(15,23,42,0.8);
  color: #f1f5f9;
  border: 2px solid rgba(100,116,139,0.3);
  font-size: 14px;
}
.card {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  border: 1px solid rgba(34,197,94,0.2);
  margin-bottom: 20px;
}
.image-container {
  width: 100%;
  max-height: 300px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
  background: rgba(15,23,42,0.6);
  border-radius: 8px;
  padding: 10px;
}
.image-container img {
  max-width: 100%;
  max-height: 280px;
  object-fit: contain;
  border-radius: 8px;
}
.question-text {
  font-size: 1.2rem;
  color: #cbd5e1;
  text-align: center;
  margin-bottom: 20px;
  line-height: 1.6;
}
.meta-info {
  text-align: center;
  color: #94a3b8;
  font-size: 13px;
  margin-bottom: 15px;
}
.options {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
@media (min-width: 640px) {
  .options { grid-template-columns: 1fr 1fr; }
}
.option {
  background: rgba(30,41,59,0.8);
  padding: 15px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid rgba(100,116,139,0.3);
  transition: all 0.2s;
  font-size: 15px;
}
.option:hover {
  background: rgba(51,65,85,0.9);
  border-color: rgba(34,197,94,0.5);
  transform: translateY(-2px);
}
.option.correct {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  border-color: #22c55e;
  font-weight: 600;
}
.option.wrong {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: #fff;
  border-color: #f87171;
  font-weight: 600;
}
.option.disabled {
  pointer-events: none;
  opacity: 0.6;
}
.explanation {
  background: rgba(15,23,42,0.9);
  padding: 20px;
  border-radius: 8px;
  border-left: 4px solid #22c55e;
  display: none;
  margin-bottom: 20px;
}
.explanation.show { display: block; }
.explanation h4 {
  color: #22c55e;
  margin-bottom: 10px;
}
.explanation p {
  margin: 10px 0;
  line-height: 1.6;
}
.explanation strong { color: #cbd5e1; }
.explanation details {
  margin-top: 15px;
}
.explanation summary {
  color: #60a5fa;
  font-weight: 600;
  cursor: pointer;
  padding: 8px;
  background: rgba(30,41,59,0.5);
  border-radius: 4px;
}
.explanation summary:hover {
  background: rgba(51,65,85,0.7);
}
.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
}
.btn-primary {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(34,197,94,0.4);
}
.btn-secondary {
  background: transparent;
  border: 2px solid rgba(34,197,94,0.4);
  color: #22c55e;
}
.btn-secondary:hover {
  background: rgba(34,197,94,0.1);
  border-color: #22c55e;
}
.loading {
  text-align: center;
  color: #60a5fa;
  padding: 40px;
}
.error {
  background: rgba(239,68,68,0.2);
  border: 2px solid #ef4444;
  color: #fca5a5;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}
.hidden { display: none; }
.unlock-toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  padding: 30px 40px;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  font-size: 1.5rem;
  font-weight: 700;
  z-index: 1000;
  animation: unlockPulse 0.6s ease-out;
}
@keyframes unlockPulse {
  0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
  50% { transform: translate(-50%, -50%) scale(1.1); }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}
</style>
</head>
<body>

<div class="container">
  <h1>üå≤ Tree & Fungi Trainer</h1>

  <!-- Developer Controls Toggle -->
  <div class="dev-toggle">
    <button onclick="toggleDevControls()">‚öôÔ∏è Developer Mode</button>
    <span class="mode-indicator mode-embedded" id="modeIndicator">üì¶ Embedded Data</span>
  </div>

  <!-- Developer Controls (Hidden by default) -->
  <div id="devControls" class="dev-controls">
    <h4>üîß Developer: Load from URLs</h4>
    <input type="text" id="urlLevel1" placeholder="Level 1 TSV URL">
    <input type="text" id="urlLevel1Hard" placeholder="Level 1 Hard TSV URL">
    <input type="text" id="urlLevel2" placeholder="Level 2 TSV URL">
    <input type="text" id="urlLevel3" placeholder="Level 3 TSV URL">
    <button class="apply-btn" onclick="loadFromUrls()">Apply URLs</button>
    <button class="apply-btn" onclick="useEmbeddedData()" style="background: #22c55e;">Switch to Embedded Data</button>
  </div>

  <!-- Level Selection -->
  <div class="level-selector">
    <div class="level-card active" id="level1Card" onclick="selectLevel('level1')">
      <div class="level-title">Level 1</div>
      <div class="level-subtitle">Foundation Knowledge</div>
      <div class="level-stats">
        <span id="level1Questions">0 questions</span>
        <span id="level1Accuracy">-</span>
      </div>
    </div>

    <div class="level-card locked" id="level2Card" onclick="selectLevel('level2')">
      <div class="level-title">Level 2</div>
      <div class="level-subtitle">Advanced Practice</div>
      <div class="level-stats">
        <span id="level2Questions">0 questions</span>
        <span id="level2Accuracy">-</span>
      </div>
      <div class="unlock-requirement">üîí Score 70%+ on Level 1 to unlock</div>
    </div>

    <div class="level-card locked" id="level3Card" onclick="selectLevel('level3')">
      <div class="level-title">Level 3</div>
      <div class="level-subtitle">Professional Assessment</div>
      <div class="level-stats">
        <span id="level3Questions">0 questions</span>
        <span id="level3Accuracy">-</span>
      </div>
      <div class="unlock-requirement">üîí Score 75%+ on Level 2 to unlock</div>
    </div>
  </div>

  <!-- Difficulty Toggle (Level 1 only) -->
  <div id="difficultyToggle" class="difficulty-toggle show">
    <label>Difficulty:</label>
    <div class="difficulty-buttons">
      <button class="diff-btn active" onclick="setDifficulty('standard')">Standard</button>
      <button class="diff-btn" onclick="setDifficulty('hard')">Hard</button>
    </div>
  </div>

  <!-- Stats Dashboard -->
  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalQuestions">-</div>
      <div class="stat-label">Questions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="attempted">0</div>
      <div class="stat-label">Attempted</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="weakCount">0</div>
      <div class="stat-label">Weak Areas</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="accuracy">-</div>
      <div class="stat-label">Accuracy</div>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <label>Category:</label>
    <select id="categoryFilter">
      <option value="">All Categories</option>
    </select>
    <button class="btn btn-secondary" onclick="resetStats()">üîÑ Reset Level Stats</button>
  </div>

  <!-- Error Display -->
  <div id="errorDisplay" class="error hidden"></div>

  <!-- Main Card -->
  <div class="card">
    <div id="loadingIndicator" class="loading">
      <p>Loading questions...</p>
    </div>

    <div id="questionDisplay" class="hidden">
      <div id="imageContainer" class="image-container hidden"></div>
      
      <div class="question-text" id="questionText">Press Practice to start</div>
      
      <div class="meta-info" id="metaInfo"></div>
      
      <div class="options" id="optionsContainer"></div>
      
      <div class="explanation" id="explanation"></div>
      
      <div class="controls">
        <button class="btn btn-primary" onclick="practiceQuestion()">üéØ Practice</button>
        <button class="btn btn-secondary" onclick="nextQuestion()">Next ‚ûî</button>
        <button class="btn btn-secondary" onclick="practiceWeak()">üí™ Weak Areas (<span id="weakCountBtn">0</span>)</button>
      </div>
    </div>
  </div>

</div>

<script>
// ============================================
// EMBEDDED DATA - PASTE YOUR TSV DATA HERE
// ============================================

const EMBEDDED_DATA = {
  level1: `/Level1.tsv`,  
  level1_hard: `/Level1_Hard.tsv`,
  
  level2: `/Level2.tsv`,
  
  level3: `pending`
};

// ============================================
// STATE MANAGEMENT
// ============================================
let allQuestions = {
  level1: [],
  level1_hard: [],
  level2: [],
  level3: []
};

let currentLevel = 'level1';
let currentDifficulty = 'standard'; // for level1
let currentQuestion = null;
let filteredQuestions = [];
let dataMode = 'embedded'; // 'embedded' or 'url'

let stats = {
  level1: { attempted: 0, correct: 0, weak: new Set() },
  level1_hard: { attempted: 0, correct: 0, weak: new Set() },
  level2: { attempted: 0, correct: 0, weak: new Set() },
  level3: { attempted: 0, correct: 0, weak: new Set() }
};

const STATS_KEY = 'treeTrainerStatsV2';
const UNLOCK_KEY = 'treeTrainerUnlocks';
const URL_KEY = 'treeTrainerUrls';

// Unlock thresholds
const UNLOCK_REQUIREMENTS = {
  level2: { level: 'level1', threshold: 70 }, // 70% on any Level 1
  level3: { level: 'level2', threshold: 75 }  // 75% on Level 2
};

// ============================================
// INITIALIZATION
// ============================================
function init() {
  loadStats();
  loadUnlocks();
  
  // Check if URLs are saved
  const savedUrls = localStorage.getItem(URL_KEY);
  if (savedUrls) {
    const urls = JSON.parse(savedUrls);
    dataMode = 'url';
    updateModeIndicator();
    loadFromUrlsData(urls);
  } else {
    // Use embedded data
    loadEmbeddedData();
  }
  
  checkUnlocks();
  updateLevelCards();
  selectLevel('level1');
}

function loadEmbeddedData() {
  dataMode = 'embedded';
  updateModeIndicator();
  
  allQuestions.level1 = parseCSV(EMBEDDED_DATA.level1);
  allQuestions.level1_hard = parseCSV(EMBEDDED_DATA.level1_hard);
  allQuestions.level2 = parseCSV(EMBEDDED_DATA.level2);
  allQuestions.level3 = parseCSV(EMBEDDED_DATA.level3);
  
  document.getElementById('loadingIndicator').classList.add('hidden');
  document.getElementById('questionDisplay').classList.remove('hidden');
  
  updateLevelCards();
  selectLevel(currentLevel);
}

async function loadFromUrls() {
  const urls = {
    level1: document.getElementById('urlLevel1').value.trim(),
    level1_hard: document.getElementById('urlLevel1Hard').value.trim(),
    level2: document.getElementById('urlLevel2').value.trim(),
    level3: document.getElementById('urlLevel3').value.trim()
  };
  
  // Validate at least one URL
  if (!urls.level1 && !urls.level1_hard && !urls.level2 && !urls.level3) {
    alert('Please enter at least one URL');
    return;
  }
  
  localStorage.setItem(URL_KEY, JSON.stringify(urls));
  dataMode = 'url';
  updateModeIndicator();
  
  await loadFromUrlsData(urls);
}

async function loadFromUrlsData(urls) {
  document.getElementById('loadingIndicator').classList.remove('hidden');
  document.getElementById('questionDisplay').classList.add('hidden');
  
  try {
    const promises = [];
    
    if (urls.level1) {
      promises.push(fetch(urls.level1).then(r => r.text()).then(text => {
        allQuestions.level1 = parseCSV(text);
      }));
    }
    
    if (urls.level1_hard) {
      promises.push(fetch(urls.level1_hard).then(r => r.text()).then(text => {
        allQuestions.level1_hard = parseCSV(text);
      }));
    }
    
    if (urls.level2) {
      promises.push(fetch(urls.level2).then(r => r.text()).then(text => {
        allQuestions.level2 = parseCSV(text);
      }));
    }
    
    if (urls.level3) {
      promises.push(fetch(urls.level3).then(r => r.text()).then(text => {
        allQuestions.level3 = parseCSV(text);
      }));
    }
    
    await Promise.all(promises);
    
    document.getElementById('loadingIndicator').classList.add('hidden');
    document.getElementById('questionDisplay').classList.remove('hidden');
    
    updateLevelCards();
    selectLevel(currentLevel);
    
  } catch (error) {
    showError('Failed to load from URLs: ' + error.message);
  }
}

function useEmbeddedData() {
  localStorage.removeItem(URL_KEY);
  document.getElementById('urlLevel1').value = '';
  document.getElementById('urlLevel1Hard').value = '';
  document.getElementById('urlLevel2').value = '';
  document.getElementById('urlLevel3').value = '';
  loadEmbeddedData();
}

function toggleDevControls() {
  const devControls = document.getElementById('devControls');
  devControls.classList.toggle('show');
}

function updateModeIndicator() {
  const indicator = document.getElementById('modeIndicator');
  if (dataMode === 'embedded') {
    indicator.className = 'mode-indicator mode-embedded';
    indicator.textContent = 'üì¶ Embedded Data';
  } else {
    indicator.className = 'mode-indicator mode-url';
    indicator.textContent = 'üîó URL Data';
  }
}

// ============================================
// STATS & UNLOCKS
// ============================================
function loadStats() {
  const saved = localStorage.getItem(STATS_KEY);
  if (saved) {
    const parsed = JSON.parse(saved);
    Object.keys(stats).forEach(level => {
      if (parsed[level]) {
        stats[level].attempted = parsed[level].attempted || 0;
        stats[level].correct = parsed[level].correct || 0;
        stats[level].weak = new Set(parsed[level].weak || []);
      }
    });
  }
}

function saveStats() {
  const toSave = {};
  Object.keys(stats).forEach(level => {
    toSave[level] = {
      attempted: stats[level].attempted,
      correct: stats[level].correct,
      weak: Array.from(stats[level].weak)
    };
  });
  localStorage.setItem(STATS_KEY, JSON.stringify(toSave));
  updateStatsDisplay();
  checkUnlocks();
}

function loadUnlocks() {
  const saved = localStorage.getItem(UNLOCK_KEY);
  if (saved) {
    const unlocks = JSON.parse(saved);
    return unlocks;
  }
  return { level1: true, level1_hard: true, level2: false, level3: false };
}

function saveUnlocks(unlocks) {
  localStorage.setItem(UNLOCK_KEY, JSON.stringify(unlocks));
}

function checkUnlocks() {
  const unlocks = loadUnlocks();
  
  // Check Level 2 unlock
  const level1Accuracy = getAccuracy('level1');
  const level1HardAccuracy = getAccuracy('level1_hard');
  const bestLevel1Accuracy = Math.max(level1Accuracy, level1HardAccuracy);
  
  if (bestLevel1Accuracy >= UNLOCK_REQUIREMENTS.level2.threshold && !unlocks.level2) {
    unlocks.level2 = true;
    saveUnlocks(unlocks);
    showUnlockToast('üéâ Level 2 Unlocked!');
  }
  
  // Check Level 3 unlock
  const level2Accuracy = getAccuracy('level2');
  if (level2Accuracy >= UNLOCK_REQUIREMENTS.level3.threshold && !unlocks.level3) {
    unlocks.level3 = true;
    saveUnlocks(unlocks);
    showUnlockToast('üéâ Level 3 Unlocked!');
  }
  
  updateLevelCards();
}

function showUnlockToast(message) {
  const toast = document.createElement('div');
  toast.className = 'unlock-toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

function getAccuracy(level) {
  if (stats[level].attempted === 0) return 0;
  return Math.round((stats[level].correct / stats[level].attempted) * 100);
}

function updateStatsDisplay() {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const currentStats = stats[levelKey];
  
  document.getElementById('totalQuestions').textContent = filteredQuestions.length;
  document.getElementById('attempted').textContent = currentStats.attempted;
  document.getElementById('weakCount').textContent = currentStats.weak.size;
  document.getElementById('weakCountBtn').textContent = currentStats.weak.size;
  
  const accuracy = getAccuracy(levelKey);
  document.getElementById('accuracy').textContent = currentStats.attempted > 0 ? accuracy + '%' : '-';
}

function updateLevelCards() {
  const unlocks = loadUnlocks();
  
  // Level 1
  const level1Total = allQuestions.level1.length + allQuestions.level1_hard.length;
  document.getElementById('level1Questions').textContent = `${level1Total} questions`;
  const level1Acc = Math.max(getAccuracy('level1'), getAccuracy('level1_hard'));
  document.getElementById('level1Accuracy').textContent = level1Acc > 0 ? level1Acc + '%' : '-';
  
  // Level 2
  document.getElementById('level2Questions').textContent = `${allQuestions.level2.length} questions`;
  const level2Acc = getAccuracy('level2');
  document.getElementById('level2Accuracy').textContent = level2Acc > 0 ? level2Acc + '%' : '-';
  
  const level2Card = document.getElementById('level2Card');
  if (unlocks.level2) {
    level2Card.classList.remove('locked');
  } else {
    level2Card.classList.add('locked');
  }
  
  // Level 3
  document.getElementById('level3Questions').textContent = `${allQuestions.level3.length} questions`;
  const level3Acc = getAccuracy('level3');
  document.getElementById('level3Accuracy').textContent = level3Acc > 0 ? level3Acc + '%' : '-';
  
  const level3Card = document.getElementById('level3Card');
  if (unlocks.level3) {
    level3Card.classList.remove('locked');
  } else {
    level3Card.classList.add('locked');
  }
}

// ============================================
// LEVEL & DIFFICULTY SELECTION
// ============================================
function selectLevel(level) {
  const unlocks = loadUnlocks();
  
  // Check if level is locked
  if (!unlocks[level]) {
    return;
  }
  
  currentLevel = level;
  
  // Update active state on cards
  document.querySelectorAll('.level-card').forEach(card => {
    card.classList.remove('active');
  });
  document.getElementById(level + 'Card').classList.add('active');
  
  // Show/hide difficulty toggle for Level 1
  if (level === 'level1') {
    document.getElementById('difficultyToggle').classList.add('show');
  } else {
    document.getElementById('difficultyToggle').classList.remove('show');
    currentDifficulty = 'standard'; // Reset difficulty when leaving L1
  }
  
  loadCurrentLevel();
}

function setDifficulty(difficulty) {
  currentDifficulty = difficulty;
  
  // Update button states
  document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  loadCurrentLevel();
}

function loadCurrentLevel() {
  let questions = [];
  
  if (currentLevel === 'level1') {
    questions = currentDifficulty === 'standard' ? allQuestions.level1 : allQuestions.level1_hard;
  } else {
    questions = allQuestions[currentLevel];
  }
  
  // Filter active questions
  questions = questions.filter(q => q.active === 'YES');
  
  buildCategoryFilter(questions);
  filterQuestions(questions);
  
  updateStatsDisplay();
}

function buildCategoryFilter(questions) {
  const categories = [...new Set(questions.map(q => q.category))].sort();
  const select = document.getElementById('categoryFilter');
  
  select.innerHTML = '<option value="">All Categories</option>';
  categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
  
  select.onchange = () => {
    const allLevelQuestions = currentLevel === 'level1' 
      ? (currentDifficulty === 'standard' ? allQuestions.level1 : allQuestions.level1_hard)
      : allQuestions[currentLevel];
    filterQuestions(allLevelQuestions.filter(q => q.active === 'YES'));
  };
}

function filterQuestions(questions) {
  const category = document.getElementById('categoryFilter').value;
  filteredQuestions = category 
    ? questions.filter(q => q.category === category)
    : [...questions];
  updateStatsDisplay();
}

// ============================================
// CSV PARSING
// ============================================
function parseCSV(csv) {
  const lines = csv.split('\n');
  const result = [];
  
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    
    const parts = lines[i].split('\t');
    if (parts.length < 14) continue;
    
    const question = {
      id: parseInt(parts[0]),
      active: parts[1],
      category: parts[2],
      question: parts[3],
      optionA: parts[4],
      optionB: parts[5],
      optionC: parts[6],
      optionD: parts[7],
      correctAnswer: parseInt(parts[8]),
      learn: parts[9],
      whyMatters: parts[10],
      deepDive: parts[11] || '',
      imageRef: parts[12] || '',
      notes: parts[13] || ''
    };
    
    result.push(question);
  }
  
  return result;
}

// ============================================
// QUESTION DISPLAY
// ============================================
function practiceQuestion() {
  const pool = filteredQuestions.length > 0 ? filteredQuestions : getCurrentQuestions();
  if (pool.length === 0) {
    alert('No questions available');
    return;
  }
  
  currentQuestion = pool[Math.floor(Math.random() * pool.length)];
  displayQuestion(currentQuestion);
}

function nextQuestion() {
  practiceQuestion();
}

function practiceWeak() {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const allLevelQuestions = getCurrentQuestions();
  const weakQuestions = allLevelQuestions.filter(q => stats[levelKey].weak.has(q.id));
  
  if (weakQuestions.length === 0) {
    alert('No weak areas yet. Answer questions incorrectly to add them here for review.');
    return;
  }
  
  currentQuestion = weakQuestions[Math.floor(Math.random() * weakQuestions.length)];
  displayQuestion(currentQuestion);
}

function getCurrentQuestions() {
  if (currentLevel === 'level1') {
    return currentDifficulty === 'standard' ? allQuestions.level1 : allQuestions.level1_hard;
  }
  return allQuestions[currentLevel];
}

function displayQuestion(q) {
  document.getElementById('explanation').classList.remove('show');
  
  // Show image if available
  const imageContainer = document.getElementById('imageContainer');
  if (q.imageRef) {
    imageContainer.innerHTML = `<img src="images/${q.imageRef}.jpg" alt="Question ${q.id}" onerror="this.parentElement.classList.add('hidden')">`;
    imageContainer.classList.remove('hidden');
  } else {
    imageContainer.classList.add('hidden');
  }
  
  // Display question
  document.getElementById('questionText').textContent = q.question;
  
  const levelDisplay = currentLevel === 'level1' 
    ? `Level 1 (${currentDifficulty === 'standard' ? 'Standard' : 'Hard'})` 
    : `Level ${currentLevel.replace('level', '')}`;
  document.getElementById('metaInfo').textContent = `${levelDisplay} | ${q.category} | Question ${q.id}`;
  
  // Shuffle options
  const options = [
    { text: q.optionA, index: 0 },
    { text: q.optionB, index: 1 },
    { text: q.optionC, index: 2 },
    { text: q.optionD, index: 3 }
  ];
  
  for (let i = options.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [options[i], options[j]] = [options[j], options[i]];
  }
  
  q._shuffledOptions = options;
  
  // Render options
  const container = document.getElementById('optionsContainer');
  container.innerHTML = '';
  
  options.forEach((opt, displayIndex) => {
    const div = document.createElement('div');
    div.className = 'option';
    div.textContent = opt.text;
    div.onclick = () => handleAnswer(q, displayIndex);
    container.appendChild(div);
  });
}

function handleAnswer(q, displayIndex) {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const options = document.querySelectorAll('.option');
  const selectedOption = q._shuffledOptions[displayIndex];
  const correctOption = q._shuffledOptions.find(opt => opt.index === q.correctAnswer);
  const correctDisplayIndex = q._shuffledOptions.indexOf(correctOption);
  
  options.forEach(opt => {
    opt.onclick = null;
    opt.classList.add('disabled');
  });
  
  stats[levelKey].attempted++;
  
  if (selectedOption.index === q.correctAnswer) {
    options[displayIndex].classList.add('correct');
    stats[levelKey].correct++;
    showExplanation(q, true);
  } else {
    options[displayIndex].classList.add('wrong');
    options[correctDisplayIndex].classList.add('correct');
    stats[levelKey].weak.add(q.id);
    showExplanation(q, false);
  }
  
  saveStats();
}

function showExplanation(q, isCorrect) {
  const explanation = document.getElementById('explanation');
  
  let html = isCorrect
    ? '<p style="color: #22c55e; font-weight: bold; font-size: 1.1rem;">‚úì Correct!</p>'
    : '<p style="color: #ef4444; font-weight: bold; font-size: 1.1rem;">‚úó Incorrect</p>';
  
  html += `<p><strong>Key Learning:</strong> ${q.learn}</p>`;
  html += `<p><strong>Why It Matters:</strong> ${q.whyMatters}</p>`;
  
  if (q.deepDive) {
    // Handle <br> tags in deepDive
    const formattedDeepDive = q.deepDive.replace(/<br>/g, '<br>');
    html += `<details><summary>üìñ Deep Dive</summary><div style="margin-top: 12px;">${formattedDeepDive}</div></details>`;
  }
  
  if (q.notes) {
    html += `<details><summary>üìù Notes</summary><div style="margin-top: 12px;">${q.notes}</div></details>`;
  }
  
  explanation.innerHTML = html;
  explanation.classList.add('show');
}

function resetStats() {
  const levelKey = currentLevel === 'level1' && currentDifficulty === 'hard' ? 'level1_hard' : currentLevel;
  const levelName = currentLevel === 'level1' 
    ? `Level 1 (${currentDifficulty === 'standard' ? 'Standard' : 'Hard'})` 
    : `Level ${currentLevel.replace('level', '')}`;
  
  if (confirm(`Reset all progress for ${levelName}? This will clear stats and weak areas for this level only.`)) {
    stats[levelKey] = { attempted: 0, correct: 0, weak: new Set() };
    saveStats();
    alert('‚úÖ Level stats reset');
  }
}

function showError(message) {
  const errorDiv = document.getElementById('errorDisplay');
  errorDiv.textContent = '‚ö† Error: ' + message;
  errorDiv.classList.remove('hidden');
}

// Initialize on load
init();
</script>

</body>
</html>
